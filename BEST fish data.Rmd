---
title: "fish_surveys"
author: "GG"
date: "March 15, 2018"
output: html_document
---

```{r setup, message = FALSE, warning=FALSE}
library(tidyverse)
library(readxl)
library(janitor)
library(dbplyr)
```

#Import data from Excel

```{r}
fish_raw <- read_excel("~/Desktop/Lionfish/BEST data/Fish Surveys.xlsx")
head(fish_raw)
```

#Gather into columns then separate out into a column for "transect" and a column for "size_class" and finally a column for the "count"

```{r}
#rm(Fish_raw)
fish_clean <- janitor::clean_names(fish_raw)

fish_tidy <- gather(data = fish_clean, key = "t_size", value = "count", -date, -survey, -site, -species) %>% separate(t_size, into = c("transect", "size"), sep = "_", convert = TRUE)

fish_tidy$count <- gsub("\\(3ft\\)", "",fish_tidy$count)
fish_tidy$count <- gsub("\\(2ft\\)", "",fish_tidy$count)
fish_tidy$count <- as.numeric(fish_tidy$count)

```

#Export as a csv

```{r}
write_csv(fish_tidy, path = "data/fish_tidy.csv")
write_excel_csv(fish_tidy, path = "~/Documents/fish_tidy.xls")
```

##HOORAY! SUCCESS

```{r}
head(fish_tidy)
```

```{r}
test <- fish_tidy %>% group_by(survey, site, species) %>%
  summarise(mn_count = mean(count, na.rm = T))
```

```{r, fig.width=9, fig.height=30}
ggplot(test, aes(x = survey, fill = site, y = mn_count)) + 
  geom_bar(stat = "identity") +
  facet_wrap(~ species, ncol = 2, scales = "free_y")
```

Importing new tidy_fish file with biomass and trophic group. 

```{r}
final_fish <- read_csv("~/Documents/fish_tidy.csv")
head(final_fish)

```

now want to make some graphs

```{r}
ggplot(data = final_fish, aes(x = survey, y=mean(biomass), fill = trophic_guild)) + geom_bar(stat = "identity") + facet_grid(site~.) 
```

```{r}
ggplot(data = final_fish, aes(x = site, y=mean(biomass))) + geom_col(aes(fill = trophic_guild)) 
```


```{r}
ggplot(data = final_fish, aes(x = survey, y=mean(density), fill = trophic_guild)) + geom_bar(stat = "identity") + facet_grid(site~.) 
```

#Overall density of each trophic guild
```{r}
ggplot(data = final_fish, aes(x = trophic_guild, y = log10(density), fill = trophic_guild)) + geom_boxplot() + theme(legend.position="none")
```

#Overall biomass of each trophic guild

```{r}
ggplot(data = final_fish, aes(x = trophic_guild, y = log10(biomass), fill = trophic_guild)) + geom_boxplot() + theme(legend.position="none")

```


# Diversity by site
```{r}
ggplot(data = final_fish, aes(x = species, y = mean(density), fill = species)) + geom_bar(stat = "identity") + facet_grid(site~.) + labs(x = "") + theme(legend.position="none") + theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))
```

```{r}
ggplot(data = final_fish, aes(x = species, y = mean(biomass), fill = species)) + geom_bar(stat = "identity") + facet_grid(site~.) + labs(x = "") + theme(legend.position="none") + theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))
```

Trying to plot the number of unique species counted per survey using facet grid for each site. Can't get it to work. 
```{r}
ggplot(data = final_fish, aes(x = survey, y = count(unique(species)))) + geom_histogram(stat = "count") + facet_grid(site~.)
```

